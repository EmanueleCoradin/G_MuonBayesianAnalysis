---
title: "Unbinned Analysis"
author: "Emanuele Coradin"
date: "`r Sys.Date()`"
output: 
  read_document: rmdformats::readthedown
  pdf_document:
    number_sections: true
    toc: true
    toc_depth: 2
  html_document:
    number_sections: true
    theme: spacelab
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

color_vector <- c("#CC0000",   # Dark red
                  "#CC79A7",   # Muted purple
                  "#D55E00",   # Vermilion
                  "#009E73",   # Bluish green
                  "#56B4E9",   # Sky blue
                  '#000046',   # Deep Blue
                  "#DB1E60",   # Pinkish-red
                  "#E69F00")   # Yellow-orange

```

```{r, message=FALSE, echo=FALSE}
library(rjags)
library(ggplot2)
library(dplyr)
library(coda)
```

# Bayesian analysis of the $\mu^+$ and $\mu^-$ lifetime in aluminum

## Introduction

The goal of this project is to obtain the lifetimes of positive and negative muons in aluminium. The given dataset contains the time passed between the implantation of the muon and its decay. 

In this document I'm exploring the following idea: 
we have three possible kinds of event, decay of either positive or negative muon or a background event. The first two will follow an exponential distribution, even though having different decay constants, while the background follows a uniform distribution. A weighted average of them will give the distribution of the data.  In this way it is possible to avoid the construction of an histogram (unbinned analysis).

## Useful functions

```{r functions}
getGammaParam <- function(mean, variance) {
  beta <- mean / variance
  alpha <- mean * beta
  c(alpha = alpha, beta = beta)
}

getBetaParam <- function(mean, variance) {
  nu <- mean * (mean * (1 - mean) / variance - 1)
  alpha <- mean * nu
  beta <- nu * (1 - mean)
  c(alpha = alpha, beta = beta)
}

prior_moments <- c(
  tau_mean = 2.1,
  tau_var = 0.05^2,
  alpha_mean = 1/3,
  alpha_var = 0.3,
  omega_mean = 4.77,
  omega_var = (4.77 * 0.04)^2 / 12,
  delta_mean = 0,
  delta_var = 0.32
)

PriorParam <- list(
  tau = getGammaParam(prior_moments['tau_mean'], prior_moments['tau_var']),
  omega = getGammaParam(prior_moments['omega_mean'], prior_moments['omega_var']),
  delta = getBetaParam((prior_moments['delta_mean'] + pi/2) / pi, prior_moments['delta_var'] * pi^-2),
  alpha = getBetaParam((prior_moments['alpha_mean'] + 1/3) / (4/3), prior_moments['alpha_var'] / (4/3)^2)
)

PriorParam
```

## Data Loading

```{r }
# Read files
paths_lifetime   <-dir('g-2data/data/lifetime/2023_24', pattern ='^t', full.names=TRUE)
paths_precession <-dir('g-2data/data/precession/2023_24', full.names=TRUE)

data_lifetime   <-numeric()
data_precession <- numeric()

for (path in paths_lifetime)   {data_lifetime   <- as.integer(c(data_lifetime, (readLines(path))))}
for (path in paths_precession) {data_precession <- as.integer(c(data_precession, (readLines(path))))}

cat('Length data_lifetime=',length(data_lifetime),'\n')
cat('Length data_precession',length(data_precession))

# Calibrate data
p0       <- 7.4
sigma_p0 <- 4.4
p1       <- 14.90
sigma_p1 <- 0.11

calibrate <- function(x) (p0 + p1 * x)*1e-3

data_lifetime   <- calibrate(data_lifetime)
data_precession <- calibrate(data_precession)

# Cleaning the dataset
data_lifetime   <- data_lifetime[data_lifetime<8]
data_precession <- data_precession[data_precession<7]

```

## Lifetime Analysis 

```{r}
zeros <- rep(0, length(data_lifetime))
dataList <- list(x = data_lifetime, zeros=zeros)

# Write JAGS model
modelString <- sprintf("
  
#model {
#    for (i in 1:length(x)) {
#      zeros[i] ~ dpois(zeros.mean[i])
#      zeros.mean[i] <- -L[i]
#      L[i] <- -x[i]/tau - log(tau)
#    }
#    tau ~ dunif(1.9,3)
#}

#model{
#  for (i in 1:length(x)) {
#    x[i] ~ dexp(1/tau)
#  }

  # Prior
#  tau ~ dunif(1.9,3)
#}

model {

  for (i in 1:length(x)) {
      zeros[i] ~ dpois(zeros.mean[i])
      zeros.mean[i] <- -L[i]
      L[i] <- log((1-noise_signal)*(exp(-x[i]/tau)/tau) + noise_signal)
  }
  
  noise_signal <- 0
  tau ~ dgamma(%.2f, %.2f)
}", PriorParam$tau["alpha"], PriorParam$tau["beta"])

# Save the model string to a file
writeLines(modelString, con = "model.jags")

```
```{r}
# Run the model
jagsModel <- jags.model(file = "model.jags", 
                        data = dataList, 
                        n.chains = 1, 
                        n.adapt = 100)

#variable.names= c('tau','tau_minus', 'fraction')
jagsSamples <- coda.samples(model = jagsModel, 
                            variable.names= c('noise_signal', 'tau'), 
                            n.iter = 500)

# Summarize and inspect results
parms <- summary(jagsSamples)$statistics[,'Mean']

summary(jagsSamples)
```

```{r plot-jags, fig.width=10, fig.height=8}
#X11(width = 10, height = 8)

plot(jagsSamples)
```

```{r}
posterior_matrix <- as.matrix(jagsSamples)

# Retrieve the chains
tau_samples <- posterior_matrix[, "tau"]

par(mfrow = c(3, 2))


acf(tau_samples, main = "Autocorrelation of tau")
```


## Precession

```{r}
model_precession <- "
model {
  for (i in 1:length(x)) {
    zeros[i] ~ dpois(zeros.mean[i])
    zeros.mean[i] <- -L[i]
    L[i] <- -x[i]/tau + log(1+alfa*cos(omega*x[i]+delta)) - log(tau) - log(FACTOR)
  }
  
  tau ~ dunif(1.9,3)
  delta ~ dunif(-3.14,3.14)
  omega ~ dunif(4.2,5.2)
  #alfa ~ dnorm(1/3,1.82)
  alfa ~ dunif(0,1)
  FACTOR <- 1 + alfa/(1+tau^2*omega^2) * (cos(delta)-tau*omega*sin(delta))
}
"

n_burnin <- 100
dataList = list(x = data_precession, zeros = rep(0, length(data_precession)))
model <- jags.model(file = textConnection(model_precession), data = dataList)
adapt(model,n_burnin)

posterior_sample <- coda.samples(model, variable.names = c('tau', 'delta','omega','alfa'), n.iter = 500, thin = 1)
summary(posterior_sample)

posterior_matrix <- as.matrix(posterior_sample)
# Retrieve the chains

tau_samples <- posterior_matrix[, "tau"]
delta_samples <- posterior_matrix[, "delta"]
omega_samples <- posterior_matrix[, "omega"]
alfa_samples <- posterior_matrix[, "alfa"]


par(mfrow = c(2, 2))

acf(tau_samples, main = "Autocorrelation of tau")
acf(delta_samples, main = "Autocorrelation of delta")
acf(omega_samples, main = "Autocorrelation of omega")
acf(alfa_samples, main = "Autocorrelation of alfa")
```
```{r , fig.width=10, fig.height=8}
plot(posterior_sample)
```
